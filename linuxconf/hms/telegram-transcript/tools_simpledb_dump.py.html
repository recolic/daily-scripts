<!DOCTYPE html>
<!-- GPT 5.2 -->
<html>
<head>
  <meta charset="utf-8">
  <title>Minimal Query Page</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
</head>
<body class="section">
  <div class="container">
    <!-- Row 1: input + button -->
    <div class="field has-addons">
      <div class="control is-expanded">
        <input id="queryInput" class="input" type="text" placeholder="Enter query">
      </div>
      <div class="control">
        <button id="submitBtn" class="button is-primary">Submit</button>
      </div>
    </div>

    <!-- Row 2: dropdown -->
    <div class="field">
      <div class="control">
        <div class="select is-fullwidth">
          <select id="exampleSelect">
            <option value="">-- Select example query --</option>
          </select>
        </div>
      </div>
    </div>

    <div id="output"></div>
  </div>

<script>
const GET_ENDPOINT = "/api";

const input = document.getElementById("queryInput");
const btn = document.getElementById("submitBtn");
const output = document.getElementById("output");
const select = document.getElementById("exampleSelect");

// naive timestamp helper (seconds)
function tsMinusDays(days) {
  return Math.floor(Date.now() / 1000) - days * 86400;
}

// hardcoded examples
const examples = [
  { label: "last 1 day", value: () => `ts gt ${tsMinusDays(1)}` },
  { label: "last 7 day", value: () => `ts gt ${tsMinusDays(7)}` },
  { label: "last 10 msg", value: () => `last 10` },
  { label: "2 day ago to 3 day ago", value: () => `ts gt ${tsMinusDays(3)} ts lt ${tsMinusDays(2)}` },
  { label: "list all chats", value: () => `countby chat_id` },
  { label: "list all chats in last 1 day", value: () => `ts gt ${tsMinusDays(1)} countby chat_id` },
  { label: "outgoing msg in last 1 day", value: () => `ts gt ${tsMinusDays(1)} is_outgoing eq true` },
  { label: "last 20 msg in specific chat", value: () => `chat_id eq <Put_Chat_Id_Here> last 20` },
  { label: "all msg from specific user", value: () => `sender_id eq <Put_Sender_Id_Here>` },
  { label: "all msg containing 'hello'", value: () => `message_text has hello` },
  { label: "count all msgs from all user", value: () => `countby sender_id` }
];

const g_token = new URLSearchParams(location.search).get("token");
if (!g_token) alert("missing HTTP GET arg: token");

// populate dropdown
examples.forEach((ex, i) => {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = ex.label;
  select.appendChild(opt);
});

// on select â†’ fill textbox
select.onchange = () => {
  const idx = select.value;
  if (idx === "") return;
  input.value = examples[idx].value();
};

btn.onclick = async () => {
  const q = input.value.trim();
  if (!q) return;

  output.innerHTML = "";
  btn.classList.add("is-loading");
  btn.disabled = true;

  try {
    const resp = await fetch(
      GET_ENDPOINT + "?token=" + g_token + "&expr=" + encodeURIComponent(q)
    );
    const text = (await resp.text()).trim();

    // non-JSON response (e.g. "E xxx")
    if (!text.startsWith("{")) {
      output.textContent = text;
      return;
    }

    const lines = text.split("\n").filter(Boolean);
    let rows;

    try {
      rows = lines.map(l => JSON.parse(l));
    } catch (e) {
      output.textContent = "Invalid JSON response:\n" + text;
      return;
    }

    const keys = Array.from(new Set(rows.flatMap(r => Object.keys(r))));

    const table = document.createElement("table");
    table.className = "table is-bordered is-narrow is-fullwidth";

    table.innerHTML =
      "<thead><tr>" +
        keys.map(k => `<th>${k}</th>`).join("") +
      "</tr></thead>";

    const tbody = document.createElement("tbody");
    rows.forEach(r => {
      const tr = document.createElement("tr");
      keys.forEach(k => {
        const td = document.createElement("td");
        td.textContent = r[k] !== undefined ? String(r[k]) : "";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    output.appendChild(table);
  } catch (e) {
    output.textContent = "Error: " + e.message;
  } finally {
    btn.classList.remove("is-loading");
    btn.disabled = false;
  }
};
</script>
</body>
</html>

