<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<section class="section">
<div class="container">

<div id="textMode">
  <div class="field">
    <div class="control">
      <textarea id="txt" class="textarea" placeholder="Paste QR string here"></textarea>
    </div>
  </div>

  <div class="buttons is-fullwidth">
    <button id="submitTxt" class="button is-primary">Submit</button>
    <button id="openCam" class="button is-link">Camera scan</button>
  </div>

  <pre id="out"></pre>
</div>

<div id="camMode" style="display:none;">
  <video id="cam" autoplay playsinline class="is-fullwidth"></video>
  <pre id="out2"></pre>
</div>

</div>
</section>
<script>
const txt = document.getElementById("txt");
const out = document.getElementById("out");
const out2 = document.getElementById("out2");

submitTxt.onclick = async () => {
  const v = txt.value.trim();
  if (!v) return;
  out.textContent = "Sending...";
  const r = await fetch("/api", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ qr:v })
  });
  out.textContent = await r.text();
};

openCam.onclick = () => {
  textMode.style.display = "none";
  camMode.style.display = "block";
  startCam().then(scan);
};

async function startCam() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" }
  });
  cam.srcObject = stream;
}

async function scan() {
  if (!window.BarcodeDetector) {
    out2.textContent = "BarcodeDetector not supported";
    return;
  }

  const detector = new BarcodeDetector({ formats:["qr_code"] });

  async function loop() {
    try {
      const codes = await detector.detect(cam);
      if (codes.length > 0) {
        const text = codes[0].rawValue;
        out2.textContent = "QR: " + text + "\nSending...";
        const res = await fetch("/api", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ qr:text })
        });
        out2.textContent = await res.text();
        return;
      }
    } catch(e) {}
    requestAnimationFrame(loop);
  }
  loop();
}
</script>

</body>
</html>

